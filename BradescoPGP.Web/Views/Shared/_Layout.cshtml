<!DOCTYPE html>
@using BradescoPGP.Common
@{
    var isEspecialista = User.IsInRole(NivelAcesso.Especialista.ToString());
    var perfil = ((System.Security.Claims.ClaimsIdentity)User.Identity).FindFirst("cargo").Value;
}
<html lang="pt-br">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="shortcut icon" href="~/favicon.ico" />
    <title>Bradesco PGP | @ViewBag.Titulo</title>
    @Styles.Render("~/Content/css")
</head>
<body class="hold-transition skin-red layout-top-nav">
    <div id="preloader">
        <div class="inner">
            <div>
                <h3 id="preloader-title">Carregando</h3>
                <div style="text-align:center" class="bolas">
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
            </div>
        </div>
    </div>
    <div class="wrapper">
        <header class="main-header navbar-static-top">
            <nav class="navbar">
                <div class="container-fluid">
                    <!--Menu status bar de Links-->
                    <div class="navbar-custom-menu">
                        <ul class="nav navbar-nav">
                            <li class="dropdown none">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="fa fa-chevron-circle-down"></i>
                                </a>
                                <ul class="dropdown-menu" id="dropdown-links-ul">
                                    <!--inserção de links dinamicamente-->
                                </ul>
                            </li>
                            <li class="custom-li" id="li-novo-link">
                                @if (User.IsInRole("Master"))
                                {
                                    <a href="#" class="custom-link" @*data-toggle="modal" data-target="#modal-novo-link"*@ id="novo-link">
                                        <span class="custom-icon"><i class="fa fa-plus-circle fa-1x green m-l-10"></i></span>
                                        <span class="hidden-xs">Cadastro de links</span>
                                    </a>
                                }
                            </li>
                            <li class="dropdown user user-menu custom-li">
                                <a href="#" class="dropdown-toggle no-border" style="margin-bottom:20px" data-toggle="dropdown">
                                    <i class="fa fa-user fa-2x user-image"></i>
                                </a>
                                <ul class="dropdown-menu">
                                    <li class="user-header">
                                        <div class="img-circlle">
                                            <i class="fa fa-user fa-5x" style="color:#fff;"></i>
                                        </div>
                                        <p>
                                            @User.Identity.Name - @(((System.Security.Claims.ClaimsIdentity)User.Identity).FindFirst("Cargo").Value)
                                        </p>
                                    </li>
                                    <li class="user-footer">
                                        <div class="pull-left">
                                            <a href="@Url.Action("Perfil", "Usuario", new { area=""})" class="btn btn-danger btn-flat">Perfil</a>
                                        </div>
                                        <div class="pull-right">
                                            <a href="@Url.Action("Logoff", "Conta", new { area=""})" class="btn btn-danger btn-flat"><i class="fa fa-sign-out"></i> Sair</a>
                                        </div>
                                    </li>
                                </ul>
                            </li>
                            @if (!User.IsInRole(NivelAcesso.Especialista.ToString()))
                            {
                                <li class="custom-li">
                                    <a href="@Url.Action("Index", "Configuracao", new { area=""})" class="custom-link-user-hover no-border">
                                        <i class="fa fa-gears"></i>
                                    </a>
                                </li>
                            }
                        </ul>
                    </div><!--/ status bar-->
                </div>
            </nav>
        </header>
        <div class="sub-nav">
            <!--Barra captação e saldo investfacil -->
            <div class="container-fluid">
                <div class="navbar-header w-100">
                    <a href="@Url.Action("Index", "Home", new { area = "" })"> <img class="logo" src="~/Medias/img/logo-bradesco.png" /></a>

                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                        <i class="fa fa-bars"></i>
                    </button>

                    <div class="pull-right collapse navbar-collapse" id="navbar-collapse">
                        <ul class="nav navbar-nav">
                            <li>
                            </li>
                            <li>
                                <a id="btn-link-capliq" href="@Url.Action("ExportarCaptacaoLiquida", new { mesAtual = true})" target="_blank" class="externalLink">
                                    <span class="custom-icon"><i class="fa fa-bank margin-r-5 bt-white"></i></span>
                                    <span class="custom-link-text">
                                        Captação Liquida<br />
                                        <span id="saldo-cap-liq" style="font-size:13px">C/Invest </span><br />
                                        <span id="saldo-cap-liq-sem-invest" style="font-size:13px"></span>
                                    </span>
                                </a>
                                <label style="display:block; color:white;text-align:center; font-size:12px;">
                                    <input type="checkbox" id="check-mes-atual" checked value="true" /> Mês Atual
                                </label>
                            </li>
                            <li>
                                <a  href="@Url.Action("ExportarInvestFacil",  new { area = ""})" target="_blank" class="externalLink">
                                    <span class="custom-icon"><i class="fa fa-line-chart bt-white"></i></span>
                                    <span class="custom-link-text">
                                        Saldo Investfacil <br />
                                        <span id="saldo-invest"></span>
                                    </span>
                                </a>
                            </li>
                            @*<li>
                                    <a href="#" onclick="core.home.novaJanela('@ViewBag.CockpitColmeia', 'CockpitColmeia')">
                                        <span class="custom-icon"><img src="~/Medias/img/hive.png" height="50" /></span>
                                        <span class="custom-link-text m-t-10" style="margin-top:20%"> Cockpit</span>
                                    </a>
                                </li>*@
                            @*<li>
                                    <a href="#" data-toggle="modal" data-target="#agora">
                                        <span style="height:50px"></span>
                                        <span class="custom-link-text m-t-10" style="margin-top:20%">Ágora</span>
                                    </a>
                                </li>*@
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!--Conteúdo geral-->
        <div class="content-wrapper">
            <div class="container-fluid">
                <div id="modais"></div>

                <section class="content-header">
                    <ol class="breadcrumb">
                        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
                    </ol>
                </section>

                <section class="content">
                    <!--Menu-->
                    @Html.Partial("MenuPartial")

                    <!-- Conteudo Principal -->
                    @RenderBody()
                </section>
            </div>
        </div>
        <!-- /.content-wrapper -->
        <!--Footer-->
        <div class="main-footer">
            <footer>
                <div class="row">
                    <div class="col-lg-6">
                        <small class="text-muted">
                            Usuario: @User.Identity.Name
                        </small>
                    </div>
                    <div class="col-lg-6">
                        <span>
                            Bradesco PGP&copy; - @DateTime.Now.Year

                        </span>
                    </div>
                </div>



            </footer>
        </div>
    </div>

    <!--Modais-->
    @* MODAL DETALHE PORTABILIADE  *@
    <div style="display:flex; text-align:left">
        <div class="modal fade" id="modal-detalhe" tabindex="-1" role="dialog" aria-labelledby="btnDetalhe" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content scroll-modal" style="border-radius:10px">
                    <div class="modal-body">
                        <div class="tab-content">
                            <div id="atendimento" class="tab-pane fade in active">
                                <h2>Atendimento</h2>
                                <div class="row" style="display: flex; flex-wrap: wrap">
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="cpf-portabilidade">CPF:</label>
                                            <input type="text" name="cpf" id="cpf-portabilidade" class="form-control" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="nome">Nome do Segurado:</label>
                                            <input type="text" name="nome" id="nome-participante" class="form-control" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="valor-previdencia">Valor da Previdência: R$</label>
                                            <input type="text" name="valor-previdencia" id="valor-previdencia" class="form-control numeric" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="consultor-pgp">Data Referência</label>
                                            <input type="text" name="consultor-pgp" id="data-ref" class="form-control" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="matricula-consultor">Matrícula Consultor</label>
                                            <input type="text" name="nome" id="matricula-consultor" class="form-control" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="encarteirado">Especialista</label>
                                            @if (perfil == "Master")
                                            {
                                                @Html.DropDownList("especialista", ViewBag.Especialistas as List<SelectListItem>, new { @class = "form-control" });
                                            }
                                            else
                                            {
                                                @Html.DropDownList("especialista", ViewBag.Especialistas as List<SelectListItem>, new { @class = "form-control", disabled = "" });
                                            }
                                        </div>
                                    </div>

                                    <div class="col-lg-4" style="height:74px">
                                        <div class="md-form fnt-14">
                                            <label for="datepicker4">Data de Solicitação</label>
                                            <input placeholder="dd/mm/aaaa" disabled type="text" id="data-solicitacao" class="form-control datepicker">
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="md-form fnt-14">
                                            <label for="datepicker7">Prazo Final</label>
                                            <input placeholder="dd/mm/aaaa" type="text" id="data-final-portabilidade" class="form-control datepicker" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="valor-solicitado">Valor Solicitado: R$</label>
                                            <input type="text" name="valor-solicitado" id="valor-solicitado" class="form-control numeric" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="Processo">Número Processo:</label>
                                            <input type="text" name="processo" id="numero-processo" class="form-control" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="proposta">Número da Proposta:</label>
                                            <input type="text" name="proposta" id="numero-proposta" class="form-control" disabled>
                                        </div>
                                    </div>

                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="segmento">Segmento:</label>
                                            <input type="text" name="segmento" id="segmento" class="form-control" disabled>
                                        </div>
                                    </div>

                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="entidade">Entidade:</label>
                                            <input type="text" name="entidade" id="entidade" class="form-control" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="susep-cedente">SUSEP Cedente</label>
                                            <input type="text" name="susep-cedente" id="susep-cedente" class="form-control" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="susep-cessionaria">SUSEP Cessionária</label>
                                            <input type="text" name="susep-cessionaria" id="susep-cessionaria" class="form-control" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="lideranca">Liderança:</label>
                                            <input type="text" name="lideranca" id="lideranca" class="form-control" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="cnpjCedente">CNPJ Cedente:</label>
                                            <input type="text" name="cnpjcedente" id="cnpj-cedente" class="form-control" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="cnpjCessionaria">CNPJ Cessionária:</label>
                                            <input type="text" name="cnpjcessionaria" id="cnpj-cessionaria" class="form-control" disabled>
                                        </div>
                                    </div>

                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="consultor-matriz">Consultor Matriz</label>
                                            <input type="text" name="consultor-matriz" id="consultor-matriz" class="form-control" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="agencia">Agência</label>
                                            <input type="text" name="agencia" disabled id="agencia-portablidade" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="conta">Conta</label>
                                            <input type="text" name="conta" disabled id="conta-portabilidade" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="status">Status:</label>
                                            @Html.DropDownList("status", (List<SelectListItem>)ViewBag.Status, new { @class = "form-control" })
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="sub-status">Sub Status:</label>
                                            @Html.DropDownList("sub-status", (List<SelectListItem>)ViewBag.SubStatus, new { @class = "form-control", disabled = "" })
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="valor-retido">Valor Retido:</label>
                                            <input type="text" name="valor-retido" id="valor-retido" disabled class="form-control numeric">
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="motivo">Motivo:</label>
                                            <select class="form-control" id="motivo"></select>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="form-group fnt-14">
                                            <label for="subMotivo">Sub Motivo:</label>
                                            <select class="form-control" id="submotivo" disabled>
                                                <option value="..."></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-lg-4" style="height:74px">
                                        <div class="md-form fnt-14">
                                            <label for="datepicker5">Data Conclusão</label>
                                            <input placeholder="dd/mm/aaaa" type="date" id="data-conclusao" class="form-control datepicker">
                                        </div>
                                    </div>

                                    <div class="col-lg-12">
                                        <div class="form-group fnt-14">
                                            <label for="observacoes">Observações:</label>
                                            <textarea name="observacao" rows="6" id="observacao" class="form-control"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="col-lg-4 pull-right">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-gradient" id="btn-atualizar">
                                <i class="fa fa-refresh icone-atualizar"></i>
                                Atualizar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    @*Modal Senha PSDC*@
    <div class="modal fade mymodal" id="modal-psdc-apic-senha" tabindex="-1" role="dialog">
        <div class="modal-dialog" style="width:800px">
            <!-- Modal content-->
            <div class="col-lg-9">
                <form action="" id="form-psdc-apic" method="post">
                    <div class="modal-content">
                        <div class="modal-header">
                            @*<button type="button" class="close" data-dismiss="modal"> <i class='fa fa-times'></i> </button>*@
                            <h4 class="modal-title">Senha APIC / PSDC</h4>
                        </div>
                        <div class="modal-body">
                            <p>Digite sua senha de acesso ao APIC e PSDC para consultas no sistema.</p>
                            <small class="text-info">*Sua senha nunca será salva em banco de dados. Será descartada quando você sair do sistema</small>
                            <br />
                            <div id="divMayus" class="text-danger" style="visibility:hidden">Caps Lock ligado.</div>
                            <div class="input-group">
                                <input type="password" name="sapa" class="form-control" onkeypress="core.home.capLock(event)" id="password-psdc-apic" />
                                <span class="input-group-btn">
                                    <button class="btn btn-default text-center" type="button" id="visualizar-senha"><i class="fa fa-eye" style=" margin-left:0"></i></button>
                                </span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary pull-right" type="submit">Enviar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade " id="modal-info-evento">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title">Info</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label for="data-inicial">Data Hora Inicial</label>
                                <input type="text" readonly id="data-inicial" class="form-control" />
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <label for="data-final">Data Hora Final</label>
                                <input type="text" readonly id="data-final" class="form-control" />
                            </div>
                        </div>
                        <div class="col-lg-12">
                            <div class="form-group">
                                <label for="hora">Descrição</label>
                                <textarea id="descricao" readonly class="form-control" rows="6"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cancelar</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>

    <div class="modal fade mymodal" id="modal-confirm" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"> <i class='fa fa-times'></i> </button>
                    <h4 class="modal-title">Confirmação</h4>
                </div>

                <div class="modal-body">
                    <div id="modal-confirm-text">

                    </div>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-success" href="#" id="btn-delete-confirm">Sim</a>
                    <button data-dismiss="modal" class="btn btn-danger">Não</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade mymodal" tabindex="-1" id="modal-cockpit" role="dialog">
        <div class="modal-dialog modal-lg">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"> <i class='fa fa-times'></i> </button>
                    <h4 class="modal-title">Cockpit</h4>
                </div>
                <div class="modal-body">
                    <iframe src="" frameborder="0" scrolling="auto" seamless="seamless" height="500" width="1000" id="frame-cockpit"></iframe>
                </div>
            </div>
        </div>
    </div>
    <div id="notificarRetencao"></div>
    <!--/Modais-->
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/inputmask")
    @*<script src="/signalr/hubs"></script>*@
    <script>

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function detalheEvento(ele) {
            $('#modal-info-evento').modal();
            $('#modal-info-evento').on('shown.bs.modal', function () {
                var modal = $(this);
                var start = $(ele).data('start');
                var end = $(ele).data('end');
                var description = $(ele).data('description');
                var title = $(ele).data('title');

                modal.find('.modal-title').text(title);
                modal.find('.modal-body #data-inicial').val(moment(start, 'YYY-MM-DD HH:mm:ss').format('DD/MM/YYYY HH:mm:ss'));
                modal.find('.modal-body #data-final').val(moment(end, 'YYY-MM-DD HH:mm:ss').format('DD/MM/YYYY HH:mm:ss'));
                modal.find('.modal-body #descricao').text(description);
            });
        }

        var notificacaoEvento = '@ViewBag.NotificacaoEvento';
        var notificacaoPipelie = '@ViewBag.NotificacaoPipeline';
        var perfilEspecialista = '@isEspecialista';

        setInterval(
            () => {
                $.ajax({
                    url: '@Url.Action("VerificarNovosTEDs", "TEDs",new { area = ""})',
                    method: 'get',
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: async function (response) {

                        if (Array.isArray(response)) {

                            for (var i = 0; i < response.length; i++)
                            {
                                core.notify.alertTeds("Nova TED", `${response[i].Agencia}`, `${response[i].Conta}`, `${response[i].NomeCliente}`, response[i].Valor, () => {  }, `@Url.Action("RedirecionarHome", "Home", new { area = "" })?agencia=${response[i].Agencia}&conta=${response[i].Conta}`);

                                await sleep(6000);
                            }
                        }
                    },
                    error: function (response) {
                        console.error(response);
                    }
                });

                if (perfilEspecialista == 'True') {

                    if (notificacaoPipelie == 'True') {
                        //Pipeline
                        $.get('@Url.Action("NotificacaoPipeline","Agenda", new { area = "" })', async function (resp) {

                            if (Array.isArray(resp)) {
                                for (var i = 0; i < resp.length; i++) {

                                    var data;

                                    if (resp[i].DataProrrogada != "" && resp[i].DataProrrogada != null) {
                                        data = moment(resp[i].DataProrrogada).format('DD/MM/YYYY HH:mm');
                                    }
                                    else {
                                        data = moment(resp[i].DataPrevista).format('DD/MM/YYYY HH:mm');
                                    }

                                    var valor = resp[i].ValorDoPipe.toLocaleString('pt-br', { currency: 'BRL', style: 'currency' });

                                    core.notify.alertPipe(data, valor, resp[i].Cliente);
                                    await sleep(6000);
                                }
                            }

                        });
                    }

                    if (notificacaoEvento == 'True') {
                        //Evento
                        $.get('@Url.Action("NotificacaoEvento","Agenda", new { area = "" })', async function (resp) {

                            if (Array.isArray(resp)) {
                                for (var i = 0; i < resp.length; i++) {
                                    var datainicio = moment(resp[i].DataHoraInicio).format('DD/MM/YYYY HH:mm');
                                    var datafim = moment(resp[i].DataFim).format('DD/MM/YYYY HH:mm');

                                    core.notify.alertEvento(resp[i].Titulo, datainicio, datafim, resp[i].Descricao);
                                    await sleep(6000);
                                }
                            }

                        });
                    }

                    //Aplicação resgate
                    $.get('@Url.Action("NotificacaoAplicacaoResgate", "AplicacaoResgate", new { area = "" })', async function (resp) {
                        if (Array.isArray(resp)) {

                            for (var i = 0; i < resp.length; i++) {
                                var data = moment(resp[i].data).format('DD/MM/YYYY');
                                if (data == moment().format('DD/MM/YYYY')) {
                                    var valor = resp[i].valor.toLocaleString('pt-BR', { currency: 'BRL', style: 'currency' });

                                    core.notify.alertAplicacaoResgate(resp[i].agencia, resp[i].conta, valor, data, resp[i].operacao);

                                    await sleep(6000);
                                }
                            }
                        }
                    });
                }
            }, 60000);

    </script>

    <script>
        $(document).ready(function () {

            //preloader
            $('html,body').animate({ scrollTop: 0 }, 'fast')
            $('#preloader .inner').fadeOut();
            $('#preloader').delay(350).fadeOut('slow');
            $('body').delay(350).css({ 'overflow': 'visible' });
            $('[data-toggle="tooltip"]').tooltip();

            core.home.init('@Url.Action("ObterInvstFacil", new { area = "" })') // Seta os header das páginas e os ifeadcrumbs

            //Carregar Links
            core.home.getLinks('@Url.Action("ObterLinks", new { area = "" })', '@User.IsInRole("Master")');

            //Criar Link
            $('#novo-link').click(function () {
                core.modal.modalNovolink('@Url.Action("NovoLink", new { area = "" })') //cria os links na barra superior de cadastro de novos links
            });

            //Remover links
            $(document).on('click', '.custom-icon-del', function () {
                var elemento = $(this);
                core.modal.modalCofirmarExclusaoLink(elemento, '@Url.Action("ExcluirLink", new { area = "" })') // Remove os links ao clicar no X
            });

            //Download Arquivos.
            $(document).on('click', '.externalLink', function () {
                var link = $(this).attr("href");
                var isLocalFile = link.indexOf("file:") >= 0;
                if (isLocalFile) {
                link = '@Url.Action("Download", new { area = "" })?file=' + link;
                    window.open(link, '_blank');
                }
                return !isLocalFile;
            });

            // Adiciona scroll nas listas de vencimentos, pipelines, teds, caso ultrapssem 100px de altura
            $('.scroll').slimScroll({ height: '200px' });

            //Mascara numerica.
            new Inputmask("(.999){+|1},99{1}", {

                radixPoint: ",",
                _radixDance: true,
                numericInput: true,
                placeholder: "0",
                definitions: {
                    "0": {
                        validator: "[0-9\uFF11-\uFF19]"
                    }
                }
            }).mask('.numeric');

            $('#check-mes-atual').change(function () {
                var url = '@Url.Action("ExportarCaptacaoLiquida")?mesAtual=' + this.checked;
                $('#btn-link-capliq').attr('href', url);
            });

        })
    </script>
    @if (Request.Path.Contains("/Portabilidade"))
    {
        //Portabilidade
        <script>

            function validarDataPesquisa(e) {
                //var de = $('#De').val();
                //var ate = $('#Ate').val();

                var data = { De: $('#De').val(), Ate: $('#Ate').val() };

                if ((data.De == '' || data.De == null) && (data.Ate == '' || data.Ate == null)) {
                    data.De = moment().subtract(12, 'months').format('L');
                    data.Ate = moment().format('L');
                }
                else {
                    data.De = moment(data.De);
                    data.Ate = moment(data.Ate);
                }

                if (data.De.isAfter(data.Ate)) {
                    e.preventDefault();
                    core.notify.showNotify("O Campo <b>De</b> não pode ser maior do que o campo <b>Até</b>", 'warning', 'top-center');
                    return;
                }
            }

            $(document).ready(function () {
                //core.notify.IniciarNotificacaoRetencao();
                const atendimento = new Atendimento();
                var solicitacaoEmAtendimento = null;
               //Exibir modal atendimento
                $(document).on('click', '#btn-detalhe', function () {

                    var tr = $(this).closest('tr');
                    var idHome = tr.last().find('span').text();

                    solicitacaoEmAtendimento = tr.attr('id') || idHome;

                    $.get('@Url.Action("ObterSolicitacao","Operacional")',{ idSolicitacao: solicitacaoEmAtendimento },function (resp) {

                        var situacao = JSON.parse(resp);

                        atendimento.preencherSolicitacao(situacao);

                        var dataFechamento = @*'@ViewBag.DataFechamento'*@ '07/01/2020';

                        var subStatus = $('#sub-status option');

                        subStatus.each(function (i, v) {
                            var valorStatusAtual = $(v).val();
                            if (valorStatusAtual == atendimento.SubStatusId) {
                                this.selected = true;
                            }
                        });

                        atendimento.popularSolicitacao(dataFechamento, '@perfil');

                        var motivos = '<option value=""></option> ';

                        $.each(situacao.MotivosCombo, function (ind, val) {
                            motivos += `<option value="${val.Key}" ${atendimento.MotivoId == val.Key ? "selected": ""}>${val.Value}</option>`;
                        });

                        $('#motivo').html(motivos);

                        var statusId = atendimento.StatusId;

                        var status = $('#status option');

                        status.each(function (i, v) {
                            var valorStatusAtual = $(v).val();
                            if (valorStatusAtual === statusId.toString()) {
                                this.selected = true;
                                let urlSubmotivo = '@Url.Action("ObterSubMotivos", "Operacional", new { area = "Portabilidade"})';
                                let urlSubStatus = '@Url.Action("ObterSubStatus", "Operacional")';
                                let valor = $(v);
                                let motivosSemSubmotivos = @Html.Raw(ViewBag?.MotivosSemSubmotivos)

                                atendimento.validarStatus(valor, motivosSemSubmotivos, urlSubmotivo, urlSubStatus);
                            }
                        });

                        var especialistas = $('#especialista option');

                        especialistas.each(function (i, ele) {

                            var especialista = $(ele).text();
                            if (especialista == atendimento.Especialista) {
                                ele.selected = true;
                            }
                        });

                        $('#tipo-contato').trigger('change');
                    })
                    .fail(function (err) { console.error(err) });
                });


                $(document).on('change', '#status', function () {
                    let urlSubmotivo = '@Url.Action("ObterSubMotivos", "Operacional")';
                    let urlSubStatus = '@Url.Action("ObterSubStatus", "Operacional")';
                    let valor = $("#modal-detalhe").find('#status').val();
                    let elemento = '';

                    $("#modal-detalhe").find('#status').children().each(function (idx, ele) {

                        if (ele.value == valor) {
                            elemento = $(ele);
                        }
                    });

                    let motivosSemSubmotivos = @Html.Raw(ViewBag.MotivosSemSubmotivos);

                    atendimento.validarStatus(elemento, motivosSemSubmotivos, urlSubmotivo, urlSubStatus, false);
                });

                $(document).on('change', '#sub-status', function () {
                    let motivosSemSubmotivos = @Html.Raw(ViewBag.MotivosSemSubmotivos);
                    let urlSubmotivo = '@Url.Action("ObterSubMotivos", "Operacional")';
                    atendimento.ValidarSubStatus(this.value, motivosSemSubmotivos, urlSubmotivo, false);
                });

                $('#motivo').change(function () {
                    let urlSubmotivo = '@Url.Action("ObterSubMotivos", "Operacional", new { area = "Portabilidade"})';
                    atendimento.MotivoId = parseInt($(this).val());
                    atendimento.validarMotivo(@Html.Raw(ViewBag.MotivosSemSubmotivos), urlSubmotivo, false);
                });

                //Atualizar Solicitacao
                $('#btn-atualizar').click(function () {
                    var valorRet = $('#valor-retido').val();
                    atendimento.DataConclusao = $('#data-conclusao').val();
                    atendimento.ValorRetido = valorRet != '' && valorRet != null
                        ? valorRet.replace(/\./g, '') : valorRet;
                    atendimento.Conta = $('#conta-portabilidade').val();
                    atendimento.Agencia = $('#agencia-portablidade').val();
                    atendimento.SubStatusId = $('#sub-status').val();
                    atendimento.MotivoId = $('#motivo').val();
                    atendimento.SubMotivoId = $('#submotivo').val();
                    atendimento.Observacao = $('#observacao').val();
                    atendimento.StatusId = $("#modal-detalhe").find("#status").val()
                    atendimento.MatriculaUsuario = $('#especialista').val();

                    //var dataProrrogada = $('#data-prorrogada').val();

                    //if (dataProrrogada != null && dataProrrogada != '') {

                    //    if (moment(dataProrrogada, 'L').isBefore(moment())) {
                    //        toastr['error']('Data Prorrogada não pode ser uma data menor do que a atual');
                    //        return;
                    //    }
                    //    atendimento.DataProrrogada = moment(dataProrrogada, "L").format('YYYY-MM-DD');
                    //    atendimento.DataFinal = moment(atendimento.DataProrrogada, 'YYYY-MM-DD').add(1, 'day').format('YYYY-MM-DD');
                    //}

                    if (atendimento.StatusId == "1018" && (atendimento.ValorRetido == "0,00" || atendimento.ValorRetido == "") && atendimento.SubStatusId == 1) {
                        toastr['error']('O campo Valor Retido é obrigatório');
                        return;
                    }

                    if (atendimento.StatusId == "1018" && atendimento.DataConclusao == "" || atendimento.DataConclusao == null) {
                        toastr['error']('Para finalizar uma solicitação é preciso informar a data de conclusão');
                        return;
                    }

                    if (atendimento.MatriculaUsuario == '') {
                        toastr['error']('O campo Especialista é obrigatório');
                        return;
                    }

                    var disabledMotivo = $('#motivo').prop('disabled');

                    if (!disabledMotivo && (atendimento.MotivoId == "" || atendimento.MotivoId == null) && atendimento.StatusId > "1018") {
                        toastr['error']('O campo Motivo é obrigatório');
                        return;
                    }

                    $.post('@Url.Action("AtualizarSituacao", "Operacional", new { area = "Portabilidade"})', atendimento, function (resp) {

                        if (resp.status) {
                            toastr['success'](resp.mensagem);

                            $("#modal-detalhe").modal('hide');

                            if ('@Request.QueryString' == "")
                                window.location.href = '@Request.Path';
                            else
                                window.location.href = '@Request.Path'+'?@Html.Raw(Request.QueryString)';

                        } else {
                            toastr['error'](resp.mensagem);
                        }
                    });

                    if (atendimento.SubStatusId == "1") {
                        $('#notificarRetencao').trigger('click');
                    }
                });

            });
        </script>

    }
    @RenderSection("scripts", required: false)

</body>
</html>
